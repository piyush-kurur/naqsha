language: c
sudo: false
# Setting up caches
cache:
  directories:
    - $HOME/.cabal/packages
    - $HOME/.cabal/store

before_cache:
  - rm -fv $HOME/.cabal/packages/hackage.haskell.org/build-reports.log
  # remove files that are regenerated by 'cabal update'
  - rm -fv $HOME/.cabal/packages/hackage.haskell.org/00-index.*
  - rm -fv $HOME/.cabal/packages/hackage.haskell.org/*.json
  - rm -fv $HOME/.cabal/packages/hackage.haskell.org/01-index.cache
  - rm -fv $HOME/.cabal/packages/hackage.haskell.org/01-index.tar
  - rm -fv $HOME/.cabal/packages/hackage.haskell.org/01-index.tar.idx
  - rm -rfv $HOME/.cabal/packages/head.hackage

fast_finish: true

addons:
  apt:
    packages:
      - libgmp-dev
    sources: [hvr-ghc]

matrix:
  include:
    - os: osx
    # Build with stack package set for 8.0.2
    - os: linux
      env: GHCVER=8.0.2 CABALVER=2.0 STACKVER=lts-9.2
      addons: {apt: {packages: [cabal-install-2.0 ,ghc-8.0.2], sources: [hvr-ghc]}}

    - os: linux
      env: GHCVER=8.2.2 CABALVER=2.0
      addons: {apt: {packages: [cabal-install-2.0 ,ghc-8.2.2], sources: [hvr-ghc]}}

    # Build with stack package sets
    - os: linux
      env: GHCVER=8.2.2 CABALVER=2.0 STACKVER=lts
      addons: {apt: {packages: [cabal-install-2.0 ,ghc-8.2.2], sources: [hvr-ghc]}}

    - os: linux
      env: GHCVER=8.4.1 CABALVER=2.0 STACKVER=nightly
      addons: {apt: {packages: [cabal-install-2.0 ,ghc-8.4.1], sources: [hvr-ghc]}}

    # Build for the GHC head and cabal-install-head
    - os: linux
      env: GHCVER=head CABALVER=head
      addons: {apt: {packages: [cabal-install-head ,ghc-head], sources: [hvr-ghc]}}

    # Lint the code.
    - os: linux
      env: HLINT="yes"
      addons: {apt: {packages: [hlint], sources: [hvr-ghc]}}

  allow_failures:
    - env: GHCVER=head CABALVER=head
    - env: HLINT="yes"

before_install:
 - if [ "$HLINT" == "yes" ]; then
      hlint "--ignore=Parse error" Naqsha;
      exit $?;
   fi

 - export PATH=/opt/ghc/$GHCVER/bin:/opt/cabal/$CABALVER/bin:$PATH;


 # Sets up the appropriate freeze.
 - if [ -n "$STACKVER" ]; then
     rm -f cabal.config;
     wget  https://www.stackage.org/"$STACKVER"/cabal.config -c;
     sed -n /naqsha/!p < cabal.config > cabal.project.freeze;
   fi

 - if [ "$TRAVIS_OS_NAME" == "osx" ]; then brew update; fi
 - if [ "$TRAVIS_OS_NAME" == "osx" ]; then brew install ghc cabal-install z3; fi
 - if [ "$TRAVIS_OS_NAME" == "osx" ]; then brew info ghc cabal-install z3 ; fi


install:
 - ghc   --version
 - cabal --version
 - travis_retry cabal update;

script:
  - cabal new-configure --enable-tests --enable-benchmarks
  - cabal new-build
  - cabal new-test
  - cabal check
  - $(find ./dist-newstyle -name raaz -type f) info

after_success:
  - echo "All is well."
after_failure:
  - echo "Build failed."

branches:
  only:
    - master
    - v0.2.0.0
